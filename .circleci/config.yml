version: 1
jobs:
  build:
    docker:
      - image: golang:latest
      - image: circleci/mongo
    # branches:
    #   only:
    #     - master
    steps:
      - checkout:
          path: /go/src/shadow
      - run:
          name: Setup Environment & Build
          command: |
            curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
            cd /go/src/shadow
            ls
            dep ensure
            cp internal/config/samples/dev.yaml.sample internal/config/dev.yaml
            go build cmd/api/server.go
            echo "CI passed!"
  deploy-vultr:
    docker:
      - image: kroniak/ssh-client
    only:
      - master
    steps:
      - add_ssh_keys:
        fingerprints:
          - "29:7d:7a:9d:c4:75:6b:13:09:fe:b0:53:22:a8:62:aa"
      - run:
          name: Deploy to Vultr
          command: |
            ssh root@139.180.221.43 cd /go/src/shadow; git pull; pm2 restart shadow
workflows:
  version: 2
  workflow:
    jobs:
    - build
    - deploy-vultr